name: Tag Artifacts

on:
  workflow_call:
    secrets:
      NEXUS3_PW:
        required: true
    inputs:
      version:
        description: 'The version to create a tag and associate components for'
        type: string
        required: true
      group_id:
        description: 'The group ID attribute'
        type: string
        required: true
      tag_name:
        description: 'The tag name to create (defaults to <group_id>-<version> if not provided)'
        type: string
        required: false
      tag_maven:
        description: 'Enable or disable tagging of maven artifacts'
        type: boolean
        required: false
        default: true
      tag_docker:
        description: 'Enable or disable tagging of Docker artifacts'
        type: boolean
        required: false
        default: true
      tag_helm:
        description: 'Enable or disable tagging of Helm artifacts'
        type: boolean
        required: false
        default: true
      tag_npm:
        description: 'Enable or disable tagging of NPM artifacts'
        type: boolean
        required: false
        default: true
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to create a tag and associate components for'
        type: string
        required: true
      group_id:
        description: 'The group ID attribute'
        type: string
        required: true
      tag_name:
        description: 'The tag name to create (defaults to <group_id>-<version> if not provided)'
        type: string
        required: false
      tag_maven:
        description: 'Enable or disable tagging of Maven artifacts'
        type: boolean
        required: false
        default: true
      tag_docker:
        description: 'Enable or disable tagging of Docker artifacts'
        type: boolean
        required: false
        default: true
      tag_helm:
        description: 'Enable or disable tagging of Helm artifacts'
        type: boolean
        required: false
        default: true
      tag_npm:
        description: 'Enable or disable tagging of NPM artifacts'
        type: boolean
        required: false
        default: true

env:
  TAG_NAME_SUFFIX_HELM: ${{ vars.TAG_NAME_SUFFIX_HELM }}
  TAG_NAME_SUFFIX_DOCKER: ${{ vars.TAG_NAME_SUFFIX_DOCKER }}
  TAG_NAME_SUFFIX_MAVEN: ${{ vars.TAG_NAME_SUFFIX_MAVEN }}
  TAG_NAME_SUFFIX_NPM: ${{ vars.TAG_NAME_SUFFIX_NPM }}
  STAGING_REPO_HELM: ${{ vars.STAGING_REPO_HELM }}
  STAGING_REPO_DOCKER: ${{ vars.STAGING_REPO_DOCKER }}
  STAGING_REPO_MAVEN: ${{ vars.STAGING_REPO_MAVEN }}
  STAGING_REPO_NPM: ${{ vars.STAGING_REPO_NPM }}

jobs:
  tag:
    name: Setup Tag Name
    runs-on: ubuntu-latest
    outputs:
      TAG_NAME: ${{ steps.tag.outputs.TAG_NAME }}
      TAG_NAME_MAVEN: ${{ steps.tag.outputs.TAG_NAME_MAVEN }}
      TAG_NAME_DOCKER: ${{ steps.tag.outputs.TAG_NAME_DOCKER }}
      TAG_NAME_HELM: ${{ steps.tag.outputs.TAG_NAME_HELM }}
      TAG_NAME_NPM: ${{ steps.tag.outputs.TAG_NAME_NPM }}
      STAGING_REPO_MAVEN: ${{ env.STAGING_REPO_MAVEN }}
      STAGING_REPO_DOCKER: ${{ env.STAGING_REPO_DOCKER }}
      STAGING_REPO_HELM: ${{ env.STAGING_REPO_HELM }}
      STAGING_REPO_NPM: ${{ env.STAGING_REPO_NPM }}
    steps:
      - name: Set Tag Name
        id: tag
        run: |
          TAG_NAME=${{ inputs.tag_name }}
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="${{ inputs.group_id }}-${{ inputs.version }}"
          fi
          TAG_NAME_MAVEN="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_MAVEN }}" # Calculate all tag names
          TAG_NAME_DOCKER="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_DOCKER }}"
          TAG_NAME_HELM="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_HELM }}"
          TAG_NAME_NPM="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_NPM }}"

          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "TAG_NAME_MAVEN=$TAG_NAME_MAVEN" >> $GITHUB_OUTPUT # Output tag names
          echo "TAG_NAME_DOCKER=$TAG_NAME_DOCKER" >> $GITHUB_OUTPUT
          echo "TAG_NAME_HELM=$TAG_NAME_HELM" >> $GITHUB_OUTPUT
          echo "TAG_NAME_NPM=$TAG_NAME_NPM" >> $GITHUB_OUTPUT
          echo "STAGING_REPO_MAVEN=${{ env.STAGING_REPO_MAVEN }}" >> $GITHUB_OUTPUT # Output repo IDs
          echo "STAGING_REPO_DOCKER=${{ env.STAGING_REPO_DOCKER }}" >> $GITHUB_OUTPUT
          echo "STAGING_REPO_HELM=${{ env.STAGING_REPO_HELM }}" >> $GITHUB_OUTPUT
          echo "STAGING_REPO_NPM=${{ env.STAGING_REPO_NPM }}" >> $GITHUB_OUTPUT

          echo "## Setup Tag Name Details" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs" >> $GITHUB_STEP_SUMMARY
          echo "- **TAG_NAME**: \`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **TAG_NAME_MAVEN**: \`$TAG_NAME_MAVEN\`" >> $GITHUB_STEP_SUMMARY
          echo "- **TAG_NAME_DOCKER**: \`$TAG_NAME_DOCKER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **TAG_NAME_HELM**: \`$TAG_NAME_HELM\`" >> $GITHUB_STEP_SUMMARY
          echo "- **TAG_NAME_NPM**: \`$TAG_NAME_NPM\`" >> $GITHUB_STEP_SUMMARY
          echo "- **STAGING_REPO_MAVEN**: \`${{ env.STAGING_REPO_MAVEN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **STAGING_REPO_DOCKER**: \`${{ env.STAGING_REPO_DOCKER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **STAGING_REPO_HELM**: \`${{ env.STAGING_REPO_HELM }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **STAGING_REPO_NPM**: \`${{ env.STAGING_REPO_NPM }}\`" >> $GITHUB_STEP_SUMMARY

  tag_mvn:
    name: Create Tag (maven)
    uses: ./.github/workflows/nexus-tag-create.yml
    needs: [tag]
    if: ${{ inputs.tag_maven }}
    with:
      name: ${{ needs.tag.outputs.TAG_NAME_MAVEN }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  tag_docker:
    name: Create Tag (docker)
    uses: ./.github/workflows/nexus-tag-create.yml
    needs: [tag]
    if: ${{ inputs.tag_docker }}
    with:
      name: ${{ needs.tag.outputs.TAG_NAME_DOCKER }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  tag_helm:
    name: Create Tag (helm)
    uses: ./.github/workflows/nexus-tag-create.yml
    needs: [tag]
    if: ${{ inputs.tag_helm }}
    with:
      name: ${{ needs.tag.outputs.TAG_NAME_HELM }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  tag_npm:
    name: Create Tag (npm)
    uses: ./.github/workflows/nexus-tag-create.yml
    needs: [tag]
    if: ${{ inputs.tag_npm }}
    with:
      name: ${{ needs.tag.outputs.TAG_NAME_NPM }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_mvn:
    name: Associate Components (maven)
    uses: ./.github/workflows/nexus-tag-associate.yml
    needs: [tag, tag_mvn]
    if: ${{ inputs.tag_maven }}
    with:
      repo_id: ${{ needs.tag.outputs.STAGING_REPO_MAVEN }}
      tag_name: ${{ needs.tag.outputs.TAG_NAME_MAVEN }}
      version: ${{ inputs.version }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_docker:
    name: Associate Components (docker)
    uses: ./.github/workflows/nexus-tag-associate.yml
    needs: [tag, tag_docker]
    if: ${{ inputs.tag_docker }}
    with:
      repo_id: ${{ needs.tag.outputs.STAGING_REPO_DOCKER }}
      tag_name: ${{ needs.tag.outputs.TAG_NAME_DOCKER }}
      version: ${{ inputs.version }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_helm:
    name: Associate Components (helm)
    uses: ./.github/workflows/nexus-tag-associate.yml
    needs: [tag, tag_helm]
    if: ${{ inputs.tag_helm }}
    with:
      repo_id: ${{ needs.tag.outputs.STAGING_REPO_HELM }}
      tag_name: ${{ needs.tag.outputs.TAG_NAME_HELM }}
      version: ${{ inputs.version }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_npm:
    name: Associate Components (npm)
    uses: ./.github/workflows/nexus-tag-associate.yml
    needs: [tag, tag_npm]
    if: ${{ inputs.tag_npm }}
    with:
      repo_id: ${{ needs.tag.outputs.STAGING_REPO_NPM }}
      tag_name: ${{ needs.tag.outputs.TAG_NAME_NPM }}
      version: ${{ inputs.version }}
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}
