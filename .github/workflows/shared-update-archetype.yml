# [Shared] Update Archetype
#
# This workflow registers a new component version in the central project blueprint (Archetype).
#
# Domain: Blueprint Management
# Contract: Requires the 'archetype-inventage-portal-solution' repository to contain a 'registerVersion.sh' script.
# Side Effects: Pushes a commit to the 'archetype-inventage-portal-solution' repository.

name: '[Shared] Update Archetype'
run-name: 'Update archetype #${{ github.run_number }} triggered by ${{ github.actor }}'

on:
  workflow_call:
    secrets:
      UNIPORT_APP_PRIVATE_KEY:
        required: true # Required to authenticate as Uniport GitHub App for cross-repo push
    inputs:
      version:
        description: 'The version string to register'
        type: string
        required: true
      component_name:
        description: 'Portal component name'
        required: true
        type: string
      command:
        description: 'The registry command (snapshot or release)'
        type: string
        default: 'snapshot'
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to register'
        type: string
        required: true
      component_name:
        description: 'Portal component name'
        required: true
        type: string
      command:
        description: 'The registry command'
        type: choice
        required: true
        default: 'snapshot'
        options:
          - 'snapshot'
          - 'release'

jobs:
  register:
    name: Update Archetype
    runs-on: ubuntu-latest
    steps:
      - name: Validate Version Format
        uses: uniport/workflows/.github/actions/base/validate-version@main
        with:
          version: ${{ inputs.version }}

      - name: Authenticate as Uniport GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.UNIPORT_APP_ID }}
          private-key: ${{ secrets.UNIPORT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            archetype-inventage-portal-solution

      - name: Checkout IPS-Archetype Repository
        uses: actions/checkout@v4
        with:
          repository: uniport/archetype-inventage-portal-solution
          token: ${{ steps.app-token.outputs.token }}
          ref: master
          path: archetype-repo

      - name: Configure Git User Identity
        run: |
          cd archetype-repo
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Register Version and Push to Archetype Repo
        run: |
          cd archetype-repo
          ./registerVersion.sh ${{ inputs.command }} "${{ inputs.component_name }}" ${{ inputs.version }}
          git push origin master
