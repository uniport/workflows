# Workflow for creating a Nexus tag
name: Create Nexus Tag
run-name: 'Nexus create tag workflow #${{ github.run_number }} triggered by ${{ github.actor }}'

on:
  workflow_call:
    secrets:
      NEXUS3_PW:
        required: true
    inputs:
      name:
        description: 'The tag name to create'
        type: string
        required: true
      kind:
        description: 'Component kind for display (e.g. docker, helm, npm)'
        type: string
        required: true
  workflow_dispatch:
    inputs:
      name:
        description: 'The tag name to create'
        type: string
        required: true

env:
  NEXUS3_URL: ${{ vars.NEXUS3_URL }}
  NEXUS3_USER: ${{ vars.NEXUS3_USER }}

jobs:
  tag:
    name: Tag (${{ inputs.kind }})
    runs-on: ubuntu-latest
    steps:
      - name: Validate Tag Name
        run: |
          if [ -z "${{ inputs.name }}" ]; then
            echo "Error: Tag name is required"
            exit 1
          fi
          
          # Check for invalid characters in tag name
           if echo "${{ inputs.name }}" | grep -qE '[^a-zA-Z0-9._-]'; then
             echo "Warning: Tag name contains special characters that may cause issues"
           fi

      # https://help.sonatype.com/en/tagging.html
      - name: Create Nexus Tag
        run: |
          echo "Creating tag: ${{ inputs.name }}"
          
          HTTP_CODE=$(curl -fSs -w "%{http_code}" -o /tmp/response.json -X POST \
            --url '${{ env.NEXUS3_URL }}/service/rest/v1/tags' \
            -u '${{ env.NEXUS3_USER }}:${{ secrets.NEXUS3_PW }}' \
            --header 'content-type: application/json' \
            --data '{"name":"${{ inputs.name }}"}')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✓ Successfully created tag"
            cat /tmp/response.json 2>/dev/null || true
          else
            echo "✗ Failed to create tag (HTTP $HTTP_CODE)"
            cat /tmp/response.json 2>/dev/null || true
            exit 1
          fi