# [Shared] Deploy DEV
#
# This workflow updates the target component version in the central IPS-Deployment repository.
# Triggering this workflow causes the ArgoCD (or similar) controller to sync the dev environment.
#
# Domain: Environment Deployment
# Contract: Requires the 'uniport-deployment' repository to contain an 'updateVersion.sh' script.
# Side Effects: Pushes a commit to the 'uniport-deployment' repository.

name: '[Shared] Deploy DEV'
run-name: 'DEV deployment #${{ github.run_number }} triggered by ${{ github.actor }} on ${{ github.ref }}'

on:
  workflow_call:
    secrets:
      UNIPORT_APP_PRIVATE_KEY:
        required: true # Required to authenticate as Uniport GitHub App for cross-repo push
    inputs:
      version:
        description: 'The version string to deploy'
        required: true
        type: string
      component_name:
        description: 'Portal component name (must match key in deployment repo)'
        required: true
        type: string
      branch:
        description: 'The branch to use in the deployment repository'
        type: string
        default: 'main'
  workflow_dispatch:
    inputs:
      version:
        description: 'The version string'
        required: true
        type: string
      component_name:
        description: 'Portal component name'
        required: true
        type: string
      branch:
        description: 'The branch to use in the deployment repository'
        required: true
        type: choice
        options:
          - main
        default: 'main'

jobs:
  deploy:
    name: Deploy (Dev)
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://ips.inventage.dev/

    steps:
      - name: Validate Version Format (Semver)
        uses: uniport/workflows/.github/actions/base/validate-version@main
        with:
          version: ${{ inputs.version }}

      - name: Authenticate as Uniport GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.UNIPORT_APP_ID }}
          private-key: ${{ secrets.UNIPORT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            uniport-deployment
            
      - name: Wait for App Token Propagation
        run: sleep 10

      - name: Checkout IPS-Deployment Repository
        uses: actions/checkout@v4
        with:
          repository: uniport/uniport-deployment
          token: ${{ steps.app-token.outputs.token }}
          ref: ${{ inputs.branch }}
          path: deployment-repo

      - name: Configure Git User Identity
        run: |
          cd deployment-repo
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Update Version and Push to Deployment Repo
        run: |
          cd deployment-repo
          ./updateVersion.sh "${{ inputs.component_name }}" "${{ inputs.version }}"
          git push origin ${{ inputs.branch }}

      - name: Generate Deployment Summary
        run: |
          echo "## Deploy DEV Details" >> $GITHUB_STEP_SUMMARY
          echo "- **version**: \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **branch**: \`${{ inputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
