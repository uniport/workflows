# [Shared] Maven Build
#
# This workflow performs the actual compilation, testing, and deployment of Maven artifacts.
# It supports projects with frontends and manages Docker registry authentication.
#
# Domain: Build Execution
# Contract: Requires a .github/settings.xml for Maven distribution management.
# Side Effects: 
#   - Pushes build artifacts to Nexus (Snapshot or Release).
#   - Publishes test, checkstyle, and spotbugs reports to the GitHub UI.
#
# Downstream: Calls internal actions for Java setup, registry login, and report publishing.

name: '[Shared] Maven Build'
run-name: 'Maven build #${{ github.run_number }} · ${{ github.ref_name }} · triggered by ${{ github.actor }}'

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      has_frontend:
        description: 'Whether the module has a frontend (activates LCOV reporting)'
        required: true
        type: boolean
      maven_verbose:
        description: 'Enable Maven debug logging (-e -X)'
        required: false
        default: false
        type: boolean
      needs_npm_access:
        description: 'Whether the module needs npm access for private registry auth'
        required: true
        type: boolean
      npmrc_path:
        description: 'Path to the .npmrc file for NPM authentication'
        required: true
        type: string
      java_version:
        description: 'Java version used for the build'
        required: true
        type: string
      timeout_minutes:
        description: 'Build timeout in minutes'
        required: false
        type: number
        default: 60
    secrets:
      NEXUS3_PW:
        required: true # Required for 'mvn deploy'
      NEXUS_NPM_TOKEN_READ_ONLY:
        required: true # Auth for internal NPM dependencies
      MACDUFF_KEYCHAIN_PASSWORD:
        required: true # Required to unlock the keychain on macOS runners for signing
      NEXUS_NPM_TOKEN_WRITE:
        required: false # Required if 'mvn deploy' includes NPM packages
    outputs:
      VERSION:
        description: 'Built artifact version (derived from RC versioning)'
        value: ${{ jobs.maven.outputs.VERSION }}
      GROUP_ID:
        description: 'The maven groupId attribute'
        value: ${{ jobs.maven.outputs.GROUP_ID }}
      run_id:
        description: 'Workflow run ID of this build'
        value: ${{ github.run_id }}
      branch_name_slug:
        description: 'Slugified current branch name'
        value: ${{ jobs.maven.outputs.branch_name_slug }}

env:
  DOCKER_CONFIG_DIRECTORY: "${{ github.workspace }}/.docker"

jobs:
  maven:
    name: Build & Publish
    runs-on: macduff # Priority: Dedicated Mac runner for performance/keychain access
    timeout-minutes: ${{ inputs.timeout_minutes }}
    env:
      CI_AUTH_USR: ${{ vars.NEXUS3_USER }}
      CI_AUTH_PSW: ${{ secrets.NEXUS3_PW }}
      HELM_REGISTRY_CONFIG: "~/.docker/config.json"
    outputs:
      VERSION: ${{ steps.vars.outputs.RC_VERSION }}
      GROUP_ID: ${{ steps.vars.outputs.GROUP_ID }}
      branch_name_slug: ${{ steps.slug.outputs.branch-name-slug }}

    steps:
      - name: Checkout Repository (Full History)
        uses: actions/checkout@v5
        with:
          # fetch-depth: 0 is required for spotless-maven-plugin branch comparisons
          fetch-depth: 0

      - name: Setup Build Variables (RC Versioning)
        id: vars
        uses: uniport/workflows/.github/actions/base/setup-maven-build-variables@main

      - name: Derive Branch Name Slug
        uses: gacts/github-slug@v1
        id: slug

      - name: Disable Background Database Triggers
        uses: uniport/workflows/.github/actions/base/disable-man-db-triggers@main

      - name: Setup Java Development Kit
        uses: uniport/workflows/.github/actions/base/setup-java@main
        with:
          architecture: ${{ contains(runner.name, 'macduff') && 'aarch64' || '' }}
          cache-maven: ${{ !contains(runner.name, 'macduff') }}
          java-version: ${{ inputs.java_version }}

      - name: Unlock macOS Keychain (for code signing)
        if: ${{ contains(runner.name, 'macduff') }}
        run: |
          security unlock-keychain -p "${{ secrets.MACDUFF_KEYCHAIN_PASSWORD }}"

      - name: Login to Uniport Docker Registry
        uses: docker/login-action@v3
        with:
          registry: uniportcr.artifacts.inventage.com
          username: ${{ env.CI_AUTH_USR }}
          password: ${{ env.CI_AUTH_PSW }}
          logout: ${{ !contains(runner.name, 'macduff') }}

      - name: Configure Read-Only NPM Registry Access
        if: ${{ inputs.needs_npm_access }}
        uses: uniport/workflows/.github/actions/base/setup-npm-nexus-access@main
        with:
          token: ${{ secrets.NEXUS_NPM_TOKEN_READ_ONLY }}
          repository: inventage-portal-npm-group
          auth-file: ${{ inputs.npmrc_path }}

      - name: Configure Staging NPM Registry Access
        if: ${{ inputs.needs_npm_access }}
        uses: uniport/workflows/.github/actions/base/setup-npm-nexus-access@main
        with:
          token: ${{ secrets.NEXUS_NPM_TOKEN_WRITE }}
          repository: inventage-portal-npm-staging
          auth-file: ${{ inputs.npmrc_path }}

      - name: Update pom.xml Project Version
        uses: uniport/workflows/.github/actions/base/set-maven-project-version@main
        with:
          version: ${{ steps.vars.outputs.RC_VERSION }}
          settings-file: .github/settings.xml
          script: true

      - name: Prepare Docker Configuration for Maven Plugin
        run: |
          cp -Rpf ~/.docker ${{ env.DOCKER_CONFIG_DIRECTORY }}

      # When cancel-in-progress terminates a running build, Maven may be mid-write
      # to maven-metadata-local.xml files in the persistent ~/.m2 cache on macduff.
      # This leaves behind truncated XML that causes parse errors in subsequent runs:
      #   "Could not parse metadata ... maven-metadata-local.xml: in epilog non whitespace
      #    content is not allowed"
      # These files are local bookkeeping only and are safely regenerated by Maven.
      - name: Clean Corrupted Maven Metadata
        run: |
          find ~/.m2/repository -name "maven-metadata-local.xml" -delete 2>/dev/null || true

      - name: Execute Maven Deploy (Build, Test, and Push)
        run: |
          mvn -B -V --no-transfer-progress --update-snapshots --settings .github/settings.xml ${{ inputs.maven_verbose && '-e -X' || '' }} -DmultiArchBuild=true deploy -Ddocker.dockerStateDir=${{ env.DOCKER_CONFIG_DIRECTORY }}
        env:
          PACKAGE_VERSION: ${{ steps.vars.outputs.RC_VERSION }}

      - name: Evaluate Report Publishing Permissions
        id: permissions
        if: ${{ success() || failure() }}
        uses: uniport/workflows/.github/actions/base/check-write-permission@main

      - name: Publish Surefire Test Results
        if: ${{ success() || failure() }}
        uses: uniport/workflows/.github/actions/base/publish-surefire-report@main
        with:
          has_permission: ${{ steps.permissions.outputs.has_permission }}

      # Reports need to run after build to ensure dependencies are present in local repo
      - name: Publish Checkstyle Static Analysis Results
        if: ${{ success() || failure() }}
        uses: uniport/workflows/.github/actions/base/publish-checkstyle-report@main
        with:
          has_permission: ${{ steps.permissions.outputs.has_permission }}

      - name: Publish SpotBugs Vulnerability Results
        if: ${{ success() || failure() }}
        uses: uniport/workflows/.github/actions/base/publish-spotbugs-report@main
        with:
          has_permission: ${{ steps.permissions.outputs.has_permission }}

      - name: Verify Clean Workspace (No Build Artifacts Leaked)
        uses: uniport/workflows/.github/actions/base/ensure-no-uncommitted-code@main

      - name: Analyze Frontend Test Coverage (LCOV)
        if: ${{ inputs.has_frontend }}
        uses: livewing/lcov-job-summary@v1.2.0
        with:
          lcov: frontend/src/main/web/coverage/lcov.info

      - name: Generate Build Summary for GitHub UI
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Maven Build
          | Output | Value |
          |--------|-------|
          | VERSION | \`${{ steps.vars.outputs.RC_VERSION }}\` |
          | GROUP_ID | \`${{ steps.vars.outputs.GROUP_ID }}\` |
          EOF