# [Shared] Nexus Tag Artifacts
#
# This workflow creates Nexus "Tags" and associates built components with them.
# Staging tags are used to identify a coherent set of artifacts for promotion to release.
#
# Domain: Artifact Management
# Contract: Requires artifacts to already exist in the staging repositories.
# Side Effects: Creates metadata tags in the Nexus 3 internal database.
#
# Downstream: Calls shared-nexus-tag-create.yml and shared-nexus-tag-associate.yml.

name: '[Shared] Nexus Tag Artifacts'

on:
  workflow_call:
    secrets:
      NEXUS3_PW:
        required: true # Required for Nexus API authentication
    inputs:
      version:
        description: 'The version to create a tag and associate components for'
        type: string
        required: true
      group_id:
        description: 'The group ID attribute (e.g. com.inventage.portal)'
        type: string
        required: true
      tag_name:
        description: 'The tag name to create (defaults to <group_id>_<version>)'
        type: string
        required: false
      tag_maven:
        description: 'Enable tagging of maven artifacts'
        type: boolean
        required: false
        default: false
      tag_docker:
        description: 'Enable tagging of Docker artifacts'
        type: boolean
        required: false
        default: false
      tag_helm:
        description: 'Enable tagging of Helm artifacts'
        type: boolean
        required: false
        default: false
      tag_npm:
        description: 'Enable tagging of NPM artifacts'
        type: boolean
        required: false
        default: false
  workflow_dispatch:
    inputs:
      version:
        description: 'The version string'
        type: string
        required: true
      group_id:
        description: 'The group ID attribute'
        type: string
        required: true
      tag_name:
        description: 'Manual override for tag name'
        type: string
        required: false
      tag_maven:
        description: 'Enable tagging of Maven artifacts'
        type: boolean
        required: false
        default: false
      tag_docker:
        description: 'Enable tagging of Docker artifacts'
        type: boolean
        required: false
        default: false
      tag_helm:
        description: 'Enable tagging of Helm artifacts'
        type: boolean
        required: false
        default: false
      tag_npm:
        description: 'Enable tagging of NPM artifacts'
        type: boolean
        required: false
        default: false

env:
  TAG_NAME_SUFFIX_HELM: ${{ vars.TAG_NAME_SUFFIX_HELM || '_helm' }}
  TAG_NAME_SUFFIX_DOCKER: ${{ vars.TAG_NAME_SUFFIX_DOCKER || '_docker' }}
  TAG_NAME_SUFFIX_MAVEN: ${{ vars.TAG_NAME_SUFFIX_MAVEN || '_maven' }}
  TAG_NAME_SUFFIX_NPM: ${{ vars.TAG_NAME_SUFFIX_NPM || '_npm' }}
  STAGING_REPO_HELM: ${{ vars.STAGING_REPO_HELM }}
  STAGING_REPO_DOCKER: ${{ vars.STAGING_REPO_DOCKER }}
  STAGING_REPO_MAVEN: ${{ vars.STAGING_REPO_MAVEN }}
  STAGING_REPO_NPM: ${{ vars.STAGING_REPO_NPM }}

jobs:
  # Generate tag names and version patterns
  setup:
    name: Setup Tag Names
    runs-on: ubuntu-latest
    outputs:
      TAG_NAME: ${{ steps.setup.outputs.TAG_NAME }}
      TAG_NAME_MAVEN: ${{ steps.setup.outputs.TAG_NAME_MAVEN }}
      TAG_NAME_DOCKER: ${{ steps.setup.outputs.TAG_NAME_DOCKER }}
      TAG_NAME_HELM: ${{ steps.setup.outputs.TAG_NAME_HELM }}
      TAG_NAME_NPM: ${{ steps.setup.outputs.TAG_NAME_NPM }}
      STAGING_REPO_MAVEN: ${{ env.STAGING_REPO_MAVEN }}
      STAGING_REPO_DOCKER: ${{ env.STAGING_REPO_DOCKER }}
      STAGING_REPO_HELM: ${{ env.STAGING_REPO_HELM }}
      STAGING_REPO_NPM: ${{ env.STAGING_REPO_NPM }}
      ALL_ARTIFACTS_VERSION: ${{ steps.setup.outputs.ALL_ARTIFACTS_VERSION }}
    steps:
      - name: Parse Version Metadata Components
        id: parse
        uses: uniport/workflows/.github/actions/base/parse-version@main
        with:
          version: ${{ inputs.version }}

      - name: Generate Standardized Nexus Tag Names
        id: setup
        run: |
          TAG_NAME=${{ inputs.tag_name }}
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="${{ inputs.group_id }}_${{ inputs.version }}"
          fi
          
          echo "Base tag name: $TAG_NAME"

          TAG_NAME_MAVEN="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_MAVEN }}" # Calculate all tag names
          TAG_NAME_DOCKER="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_DOCKER }}"
          TAG_NAME_HELM="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_HELM }}"
          TAG_NAME_NPM="${TAG_NAME}${{ env.TAG_NAME_SUFFIX_NPM }}"

          # Calculate the pattern used to find artifacts in Nexus based on build metadata
          VERSION_SUFFIX="${{ steps.parse.outputs.build_date }}-${{ steps.parse.outputs.run_id }}-${{ steps.parse.outputs.commit_sha }}"
          ALL_ARTIFACTS_VERSION="*-${VERSION_SUFFIX}"
          
          echo "Maven version pattern: $ALL_ARTIFACTS_VERSION"
          
          # Export outputs
          cat >> $GITHUB_OUTPUT <<EOF
          TAG_NAME=$TAG_NAME
          TAG_NAME_MAVEN=$TAG_NAME_MAVEN
          TAG_NAME_DOCKER=$TAG_NAME_DOCKER
          TAG_NAME_HELM=$TAG_NAME_HELM
          TAG_NAME_NPM=$TAG_NAME_NPM
          STAGING_REPO_MAVEN=${{ env.STAGING_REPO_MAVEN }}
          STAGING_REPO_DOCKER=${{ env.STAGING_REPO_DOCKER }}
          STAGING_REPO_HELM=${{ env.STAGING_REPO_HELM }}
          STAGING_REPO_NPM=${{ env.STAGING_REPO_NPM }}
          ALL_ARTIFACTS_VERSION=$ALL_ARTIFACTS_VERSION
          EOF

      - name: Generate Tag Configuration Summary
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF  
          ## Setup Tag Name Details
          ### Outputs
          - **TAG_NAME**: \`${{ steps.setup.outputs.TAG_NAME }}\`
          - **TAG_NAME_MAVEN**: \`${{ steps.setup.outputs.TAG_NAME_MAVEN }}\`
          - **TAG_NAME_DOCKER**: \`${{ steps.setup.outputs.TAG_NAME_DOCKER }}\`
          - **TAG_NAME_HELM**: \`${{ steps.setup.outputs.TAG_NAME_HELM }}\`
          - **TAG_NAME_NPM**: \`${{ steps.setup.outputs.TAG_NAME_NPM }}\`
          - **STAGING_REPO_MAVEN**: \`${{ env.STAGING_REPO_MAVEN }}\`
          - **STAGING_REPO_DOCKER**: \`${{ env.STAGING_REPO_DOCKER }}\`
          - **STAGING_REPO_HELM**: \`${{ env.STAGING_REPO_HELM }}\`
          - **STAGING_REPO_NPM**: \`${{ env.STAGING_REPO_NPM }}\`
          - **ALL_ARTIFACTS_VERSION**: \`${{ steps.setup.outputs.ALL_ARTIFACTS_VERSION }}\`
          EOF

  # Create tags for enabled artifact types
  tag_mvn:
    name: Tag
    uses: ./.github/workflows/shared-nexus-tag-create.yml
    needs: [setup]
    if: ${{ inputs.tag_maven }}
    with:
      name: ${{ needs.setup.outputs.TAG_NAME_MAVEN }}
      kind: maven
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  tag_docker:
    name: Tag
    uses: ./.github/workflows/shared-nexus-tag-create.yml
    needs: [setup]
    if: ${{ inputs.tag_docker }}
    with:
      name: ${{ needs.setup.outputs.TAG_NAME_DOCKER }}
      kind: docker
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  tag_helm:
    name: Tag
    uses: ./.github/workflows/shared-nexus-tag-create.yml
    needs: [setup]
    if: ${{ inputs.tag_helm }}
    with:
      name: ${{ needs.setup.outputs.TAG_NAME_HELM }}
      kind: helm
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  tag_npm:
    name: Tag
    uses: ./.github/workflows/shared-nexus-tag-create.yml
    needs: [setup]
    if: ${{ inputs.tag_npm }}
    with:
      name: ${{ needs.setup.outputs.TAG_NAME_NPM }}
      kind: npm
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  # Associate artifacts with tags
  associate_mvn:
    name: Associate
    uses: ./.github/workflows/shared-nexus-tag-associate.yml
    needs: [setup, tag_mvn]
    if: ${{ inputs.tag_maven }}
    with:
      repo_id: ${{ needs.setup.outputs.STAGING_REPO_MAVEN }}
      tag_name: ${{ needs.setup.outputs.TAG_NAME_MAVEN }}
      version: ${{ needs.setup.outputs.ALL_ARTIFACTS_VERSION }}
      kind: maven
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_docker:
    name: Associate
    uses: ./.github/workflows/shared-nexus-tag-associate.yml
    needs: [setup, tag_docker]
    if: ${{ inputs.tag_docker }}
    with:
      repo_id: ${{ needs.setup.outputs.STAGING_REPO_DOCKER }}
      tag_name: ${{ needs.setup.outputs.TAG_NAME_DOCKER }}
      version: '"${{ inputs.version }}"'
      kind: docker
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_helm:
    name: Associate
    uses: ./.github/workflows/shared-nexus-tag-associate.yml
    needs: [setup, tag_helm]
    if: ${{ inputs.tag_helm }}
    with:
      repo_id: ${{ needs.setup.outputs.STAGING_REPO_HELM }}
      tag_name: ${{ needs.setup.outputs.TAG_NAME_HELM }}
      version: '"${{ inputs.version }}"'
      kind: helm
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}

  associate_npm:
    name: Associate
    uses: ./.github/workflows/shared-nexus-tag-associate.yml
    needs: [setup, tag_npm]
    if: ${{ inputs.tag_npm }}
    with:
      repo_id: ${{ needs.setup.outputs.STAGING_REPO_NPM }}
      tag_name: ${{ needs.setup.outputs.TAG_NAME_NPM }}
      version: '"${{ inputs.version }}"'
      kind: npm
    secrets:
      NEXUS3_PW: ${{ secrets.NEXUS3_PW }}
