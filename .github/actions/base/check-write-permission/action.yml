name: Check Write Permission
description: Check if the workflow has checks:write permission for report publishing

outputs:
  has_permission:
    description: 'true if checks:write permission is available, false otherwise'
    value: ${{ steps.check.outputs.has_permission }}

runs:
  using: composite
  steps:
    - name: Check checks:write permission
      id: check
      shell: bash
      run: |
        # Test if we have checks:write permission by attempting to create a check run.
        # 422 = permission granted (invalid request body), 403 = no permission
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
          -H "Authorization: Bearer ${{ github.token }}" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/${{ github.repository }}/check-runs" \
          -d '{}')
        if [[ "$HTTP_CODE" != "403" ]]; then
          echo "has_permission=true" >> $GITHUB_OUTPUT
        else
          echo "has_permission=false" >> $GITHUB_OUTPUT
          echo "::notice::checks:write permission not available"
        fi
