name: SpotBugs Summary
description: Renders SpotBugs results as a summary table with clickable links

inputs:
  path:
    description: 'Glob pattern to find spotbugsXml.xml files'
    required: false
    default: '**/spotbugsXml.xml'

runs:
  using: composite
  steps:
    - name: Render SpotBugs Summary
      shell: python3 {0}
      continue-on-error: true
      env:
        GITHUB_REPO_URL: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}
      run: |
        import glob
        import os
        import xml.etree.ElementTree as ET

        repo_url = os.environ["GITHUB_REPO_URL"]
        summary_file = os.environ["GITHUB_STEP_SUMMARY"]

        SEVERITY = {"1": "ðŸ”´ High", "2": "ðŸŸ  Medium", "3": "ðŸŸ¡ Low"}

        xml_files = glob.glob("**/spotbugsXml.xml", recursive=True)

        lines = ["## SpotBugs Results", ""]

        if not xml_files:
            lines.append("ðŸ“­ No reports available")
            with open(summary_file, "a") as f:
                f.write("\n".join(lines) + "\n")
            raise SystemExit(0)

        lines.append("| Severity | File | Line | Bug Type | Message |")
        lines.append("|----------|------|------|----------|---------|")

        # Collect all source directories for each XML file's project
        total = 0

        for xml_file in sorted(xml_files):
            # e.g. backend/target/spotbugsXml.xml -> backend
            module = os.path.dirname(xml_file).removesuffix("/target").removeprefix("./")

            try:
                tree = ET.parse(xml_file)
            except ET.ParseError:
                lines.append(f"| âš ï¸ | Error parsing: {xml_file} | | | |")
                continue

            root = tree.getroot()

            # Resolve all possible source roots from the XML's SrcDir elements.
            # The SrcDir is an absolute path â€” we only need the part relative to the module directory.
            src_suffixes = []
            for sd in root.iter("SrcDir"):
                if sd.text:
                    # Logic: find the part of the absolute path that follows the module name
                    # e.g., /home/runner/work/repo/repo/backend/src/main/java -> src/main/java
                    parts = sd.text.split(f"/{module}/", 1)
                    if len(parts) == 2:
                        src_suffixes.append(parts[1].rstrip("/"))
            
            if not src_suffixes:
                src_suffixes = ["src/main/java"] # Fallback

            for bug in root.iter("BugInstance"):
                bug_type = bug.get("type", "")
                priority = bug.get("priority", "3")
                sev = SEVERITY.get(priority, "ðŸŸ¡ Low")

                message = ""
                msg_el = bug.find(".//ShortMessage")
                if msg_el is not None and msg_el.text:
                    message = msg_el.text.strip()

                source_file = ""
                source_line = ""
                # Prefer primary SourceLine, fall back to first
                for sl in bug.iter("SourceLine"):
                    sp = sl.get("sourcepath", "")
                    ln = sl.get("start", "")
                    if not source_file and sp:
                        source_file = sp
                        source_line = ln
                    if sl.get("primary") == "true" and sp:
                        source_file = sp
                        source_line = ln
                        break

                if source_file and bug_type:
                    # Dynamically resolve which src_suffix contains the source_file
                    resolved_suffix = src_suffixes[0]
                    for suffix in src_suffixes:
                        # Check if the file exists at this path relative to the repo root
                        potential_path = f"{module}/{suffix}/{source_file}" if module else f"{suffix}/{source_file}"
                        if os.path.exists(potential_path):
                            resolved_suffix = suffix
                            break

                    file_path = f"{module}/{resolved_suffix}/{source_file}" if module else f"{resolved_suffix}/{source_file}"
                    class_name = os.path.basename(source_file)
                    display = f"{module}: {class_name}" if module else class_name
                    file_link = f"[`{display}`]({repo_url}/{file_path}#L{source_line})"
                    lines.append(f"| {sev} | {file_link} | {source_line} | `{bug_type}` | {message} |")
                    total += 1

        lines.append("")
        if total == 0:
            lines.append("âœ… No bugs found")
        else:
            lines.append(f"**Total: {total} bug(s)**")

        with open(summary_file, "a") as f:
            f.write("\n".join(lines) + "\n")
